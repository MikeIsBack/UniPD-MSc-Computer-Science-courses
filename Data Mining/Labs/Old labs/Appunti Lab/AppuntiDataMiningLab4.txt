Carichiamo la libreria che si chiama come il libro:

library(ISLR)

Da esterno al lab questa libreria si puo' installare con install.packages('ISLR')
Carichiamo il dataset sui seggiolini per bambini:

data(Carseats)

Vediamo la sua dimensione:

dim(Carseats)

Le variabili contenute:

names(Carseats)

Ora vogliamo valutare la vendita per seggilini per auto in base al prezzo ed altre caratteristiche che vedremo.
Analizziamo l'help:

?Carseats

Selezioniamo una parte delle variabili e lavoriamo direttamente con quelle.
Selezioniamo solo una parte delle variabili che ci interessa.
Per selezionare una parte delle colonne digitiamo:

dati <- Carseats[,c('Sales', 'Price', 'Urban', 'US', 'ShelveLoc')]

Nota: la virgola all'inizio e' perche non vogliamo filtrare nessuna riga, le prendiamo tutte.
Vediamo la dimensioni di dati:

dim(dati)

Verifichiamo i nomi con:

names(dati)

Il nostro scopo e' quello di prevedere Sales in funzione delle altre 4 variabili.
Vediamo se questa Sales puo' essere addattata ad un modello di regressione lineare.
Creiamo il solito boxplot.

boxplot(dati$Sales, ylab='Sales', cex.lab=2, cex.axis=2)

Come possiamo vedere, abbiamo una bella distribuzione (praticamente simmetrica nella scatola della mediana), e abbiamo solamente due punti che "scappano".
Se un boxplot fosse asimmetrico posso provare a considerare in una maniera diversa: per esempio con la radice di y o con il suo logaritmo.
Verifichiamo l'isogramma:

hist(dati$Sales, prob=TRUE)

Come possiamo vedere anche l'istogramma va bene e crea una bella campana.
Ora creiamo il plot di _prices_ e _sales_:

plot(dati$Price, dati$Sales)

Da qui possiamo vedere l'associazione negativa (all'aumentare del prezzo diminuisce la vendita). Vediamo che ci sono tanti punti variabili, e facendo passare una retta avremmo tantissima dispersione, facendo vedere come con una retta ci sarebbe poca rappresentazione.
Ora verifichiamo se c'e' una variazione di _sales_ in variazione di urban:

boxplot(dati$Sales ~ dati$Urban)

Da come possiamo notare, non c'e' influenza (almeno a livello marginale). Sembra che non ci sia differenza di andamento mediano delle vendite tra le zone urbane e non urbane.
Verifichiamo che valga la stessa cosa con US:

boxplot(dati$Sales ~ dati$US)

Sembrano che le vendite negli stati uniti le vendite siano in mediana maggiori rispetto all'esterno, e anche la variabilita' e' maggiore.
Verifichiamo ora con il ShelveLoc:

boxplot(dati$Sales ~ dati$ShelveLoc)

Qui possiamo notare molta differenziazione.
Siccome i valori sembrano buoni aggiungeremo tutti nel modello.
Ora vediamo se c'e' interazione tra prezzo e una delle variabili qualitative. Proviamo a vedere se graficamente puo' esistere una interazione tra _Price_ e _ShelveLoc_. Quindi rappresentiamo i dati in un grafico di dispersione e poi individuiamo i tre gruppi.
Il grafico di dispersione e' lo stesso gia' visto prima:

plot(dati$Price, dati$Sales)

A cui aggiungiamo ora i tre punti di _ShelveLoc_.
Usiamo points, che richiede la stessa ascissa e la stessa ordinata, ma aggiungeremo un livello di _ShelveLoc_ uno alla volta.

points(dati$Price[dati$ShelveLoc=='Bad'], dati$Sales[dati$ShelveLoc=='Bad'], col='red', pch=19)

Lo facciamo per i seggiolini "buoni":

points(dati$Price[dati$ShelveLoc=='Good'], dati$Sales[dati$ShelveLoc=='Good'], col='green', pch=19)

Inseriamo una legenda per avere una migliore complrensione del grafico:

legend('bottomleft', pch=c(19,19,19), col=c('red', 'green', 'black'), legend=c('Bad', 'Good', 'Medium'), bty='n')

Cosi' a occhio il grafico non suggerisce interazione, anche se e' vero che la parte verde e' un po' staccata da quella rossa, anche se e' vero che i punti sono un po' sparsi nella nuvola. Probabilmente (ma non e' sicuro), invece di dividere in tre livelli ma ne facessi solo due (solo buono/cattivo), allora prabilmente ci sarebbero due gruppi delineati. La possibilita' e' che il gruppo verde e quello rosso siano cosi' influenti sulle osservazioni Y che mi fanno orientare le rette di regressione in modo diverso.
Se c'e' qualche interazioni tra i punti ci sarebbero dei cambiamenti dell'inclinazione della retta.
La stessa cosa si puo' fare con le due variabili quantitative (che non vedremo) che ci potrebbero suggerire o meno interazioni.
Ora costruiamo il modello.
Proviamo a costruire un modello con tutte le variabili esplicative:

m <- lm(Sales ~ Price + Urban + US + ShelveLoc, data=dati)

Ovvero abbiamo un modello di questo tipo:
Y = beta0 + beta1 x1 + beta2 x2 + beta3 x3 + beta4 x4 + epsilon.
Vediamo il summary:

summary(m)

Che ci da:

> summary(m)

Call:
lm(formula = Sales ~ Price + Urban + US + ShelveLoc, data = dati)

Residuals:
    Min      1Q  Median      3Q     Max 
-5.0042 -1.2829 -0.0053  1.2471  4.6856 

Coefficients:
                 Estimate Std. Error t value Pr(>|t|)    
(Intercept)     11.320199   0.514569  21.999  < 2e-16 ***
Price           -0.058053   0.003941 -14.731  < 2e-16 ***
UrbanYes         0.245370   0.204700   1.199    0.231    
USYes            1.002308   0.195132   5.137 4.41e-07 ***
ShelveLocGood    4.853360   0.278001  17.458  < 2e-16 ***
ShelveLocMedium  1.913316   0.227969   8.393 8.61e-16 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1.856 on 394 degrees of freedom
Multiple R-squared:  0.5734,	Adjusted R-squared:  0.568 
F-statistic: 105.9 on 5 and 394 DF,  p-value: < 2.2e-16



Vediamo che Urban non e' influente nel grafico (questo ce lo diceva gia' il boxplot). Veidamo che la vendita negli stati uniti e' un dato influente.
Con ShelveLoc possiamo notare che abbiamo due livelli (e' la prima volta che ci capita). Il livello bad e' quello di base e non e' presente nell'output, ma sono presenti quelli good e medium. Possiamo vedere che con il modello Good le vendite aumentano di quattro volte rispetto a quelli medium. Questa crescita e' coerente con l'analisi esplorativa vista prima (i boxplot). E' tutto coerente e funzione.
L'R2 e' basso, pero' e' vero che sono presenti poche variabili.
Ora proviamo a inserire una interazione.
Aggiorniamo il modello rimuovendo Urban che abbiamo visto che non e' utile:

m2 <- update(m, . ~ . - Urban)

Versione alternativa:

m2 <- lm(Sales ~ Price + Us + ShelveLoc, data=dati)

Vediamo il summary(m2) cosa ci restituisce:

> summary(m2)

Call:
lm(formula = Sales ~ Price + US + ShelveLoc, data = dati)

Residuals:
    Min      1Q  Median      3Q     Max 
-5.1720 -1.2587 -0.0056  1.2815  4.7462 

Coefficients:
                 Estimate Std. Error t value Pr(>|t|)    
(Intercept)     11.476347   0.498083  23.041  < 2e-16 ***
Price           -0.057825   0.003938 -14.683  < 2e-16 ***
USYes            1.013071   0.195034   5.194 3.30e-07 ***
ShelveLocGood    4.827167   0.277294  17.408  < 2e-16 ***
ShelveLocMedium  1.893360   0.227486   8.323 1.42e-15 ***
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1.857 on 395 degrees of freedom
Multiple R-squared:  0.5718,	Adjusted R-squared:  0.5675 
F-statistic: 131.9 on 4 and 395 DF,  p-value: < 2.2e-16

Come vediamo l'R2 si e' abbassato ma in maniera inifluente, quindi abbiamo fatto bene a rimuovere Urban.
La funzione anova() ci permette di esegurie l'analisi della varianza, con una precisazione: ovvero e' un tipo di analisi statistica (di data mining) che non confronta modelli annidati. Il termine in R confronta una cosa diversa, significa fare il confronto tra varianza, e non ha niente a che fare con quello scritto nel libro di testo.
Lanciamo il comando tra i due modelli:

anova(m2, m)

Mettiamo prima il modello piu' grande e quello piu' piccolo poi.
Che ci da in output:

> anova(m2, m)
Analysis of Variance Table

Model 1: Sales ~ Price + US + ShelveLoc
Model 2: Sales ~ Price + Urban + US + ShelveLoc
  Res.Df    RSS Df Sum of Sq      F Pr(>F)
1    395 1362.6                           
2    394 1357.6  1     4.951 1.4368 0.2314

Quindi abbiamo, riprenderndo la formula di F:

F = RSS0 - RSS   n-p-1
    ---------- x -----
        RSS        q

Con:
- RSS0 = 1362.6
- RSS = 1357.6
- (n-p-1)/q = 395/1
- p-value = 0.2314

Ottenendo un F = 1,4368.

Calcoliamo il quantile di riferimento:

qf(0.95,1,395)

Che ci da 3.865108, che e' con alpha=0,05.
Per calcolar il p-value in R i conti sono:

1-pf(1.4368, 1, 395)

Che ci da il p-value di 0.2313765.
In ogni caso, con il risultato che abbiamo e' che F e' minore del quantile, e quindi teniamo il modello piu' piccolo.
Note:
- la statistica F corrisponde con t^2.
- la statistica F e' sempre maggiore di 0 e la rifiutiamo per valori grandi, la statistica T no invece.

Aggiungiamo un'interazione al modello:

m3 <- lm(Sales ~ Price + US + ShelveLoc + Price:ShelveLoc, data=dati)

Possiamo fare anche in questa maniera:

m3 <- lm(Sales ~ Price * ShelveLoc + US, data=dati)

Per essere precisi, dovremmo testare tutte le iterazioni he andiamo ad aggiungere al modello, ama non lo fa nessuno. Questo perche' aggiungiamo robe che si adattano benissimo al modello, ma che quando escono dal training set fanno schifo. Di solito si aggiungono le iterazioni tra una quantitativa e una qualitativa hanno senso anche graficamente. Tipicamente non si mettono le interazioni tra due variabili quantitative.
Vediamo il `summary(m3)`:

> summary(m3)

Call:
lm(formula = Sales ~ Price + US + ShelveLoc + Price:ShelveLoc, 
    data = dati)

Residuals:
    Min      1Q  Median      3Q     Max 
-5.2497 -1.2567 -0.0158  1.2418  4.5909 

Coefficients:
                       Estimate Std. Error t value Pr(>|t|)    
(Intercept)           11.365656   0.940335  12.087  < 2e-16 ***
Price                 -0.056816   0.008027  -7.079 6.75e-12 ***
USYes                  1.005919   0.195317   5.150 4.12e-07 ***
ShelveLocGood          5.870530   1.350791   4.346 1.77e-05 ***
ShelveLocMedium        1.645606   1.135419   1.449    0.148    
Price:ShelveLocGood   -0.008877   0.011384  -0.780    0.436    
Price:ShelveLocMedium  0.002128   0.009697   0.219    0.826    
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 1.859 on 393 degrees of freedom
Multiple R-squared:  0.5732,	Adjusted R-squared:  0.5667 
F-statistic: 87.98 on 6 and 393 DF,  p-value: < 2.2e-16

Come possiamo vedere (i due livelli si vedono sempre in coppia), i due livelli vanno considerati insieme, e vediamo che non sono significativi per ShelveLoc.
Ora vediamo come si comportano i due modelli:

anova(m2, m3)

Che ci restituisce:

> anova(m2, m3)
Analysis of Variance Table

Model 1: Sales ~ Price + US + ShelveLoc
Model 2: Sales ~ Price + US + ShelveLoc + Price:ShelveLoc
  Res.Df    RSS Df Sum of Sq     F Pr(>F)
1    395 1362.6                          
2    393 1358.1  2    4.4789 0.648 0.5236


In questo lab manca tutta la parte di analisi dei residui, che faremo in un altro lab.
